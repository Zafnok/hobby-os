const std = @import("std");
const framebuffer = @import("framebuffer.zig");

// 8x8 Bitmap Font (IBM VGA 8x8 inspired)
// Covering ASCII 32 (Space) to 127 (DEL)
// Each row is a byte, MSB left.
const font_data = [_][8]u8{
    // Space (32)
    .{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    // !
    .{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00 },
    // "
    .{ 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00 },
    // #
    .{ 0x7F, 0x7F, 0x06, 0x7F, 0x7F, 0x06, 0x7F, 0x7F }, // Placeholder-ish
    // $
    .{ 0x24, 0x2A, 0x7F, 0x2A, 0x12, 0x00, 0x00, 0x00 }, // Placeholder-ish
    // %
    .{ 0x23, 0x13, 0x08, 0x64, 0x62, 0x00, 0x00, 0x00 }, // Placeholder-ish
    // &
    .{ 0x36, 0x49, 0x35, 0x00, 0x00, 0x00, 0x00, 0x00 }, // Placeholder-ish
    // '
    .{ 0x18, 0x18, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00 }, // '
    // (
    .{ 0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00 },
    // )
    .{ 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00 },
    // *
    .{ 0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00 },
    // +
    .{ 0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00 },
    // ,
    .{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x08 },
    // -
    .{ 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00 },
    // .
    .{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00 },
    // /
    .{ 0x00, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x00 },
    // 0
    .{ 0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00 },
    // 1
    .{ 0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00 },
    // 2
    .{ 0x3C, 0x66, 0x06, 0x0C, 0x30, 0x60, 0x7E, 0x00 },
    // 3
    .{ 0x3C, 0x66, 0x06, 0x1C, 0x06, 0x66, 0x3C, 0x00 },
    // 4
    .{ 0x06, 0x0E, 0x1E, 0x36, 0x66, 0x7F, 0x06, 0x00 },
    // 5
    .{ 0x7E, 0x60, 0x7C, 0x06, 0x06, 0x66, 0x3C, 0x00 },
    // 6
    .{ 0x3C, 0x66, 0x60, 0x7C, 0x66, 0x66, 0x3C, 0x00 },
    // 7
    .{ 0x7E, 0x06, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00 },
    // 8
    .{ 0x3C, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x3C, 0x00 },
    // 9
    .{ 0x3C, 0x66, 0x66, 0x3E, 0x06, 0x66, 0x3C, 0x00 },
    // :
    .{ 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00 },
    // ;
    .{ 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x08 },
    // <
    .{ 0x0C, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0C, 0x00 },
    // =
    .{ 0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00 },
    // >
    .{ 0x30, 0x18, 0x0C, 0x06, 0x0C, 0x18, 0x30, 0x00 },
    // ?
    .{ 0x3C, 0x66, 0x06, 0x0C, 0x18, 0x00, 0x18, 0x00 },
    // @
    .{ 0x3E, 0x63, 0x7B, 0x7B, 0x7B, 0x03, 0x1E, 0x00 },
    // A
    .{ 0x18, 0x3C, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x00 },
    // B
    .{ 0x7C, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x7C, 0x00 },
    // C
    .{ 0x3C, 0x66, 0x60, 0x60, 0x60, 0x66, 0x3C, 0x00 },
    // D
    .{ 0x78, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0x78, 0x00 },
    // E
    .{ 0x7E, 0x60, 0x60, 0x78, 0x60, 0x60, 0x7E, 0x00 },
    // F
    .{ 0x7E, 0x60, 0x60, 0x78, 0x60, 0x60, 0x60, 0x00 },
    // G
    .{ 0x3C, 0x66, 0x60, 0x6E, 0x66, 0x66, 0x3C, 0x00 },
    // H
    .{ 0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00 },
    // I
    .{ 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00 },
    // J
    .{ 0x06, 0x06, 0x06, 0x06, 0x06, 0x66, 0x3C, 0x00 },
    // K
    .{ 0x66, 0x6C, 0x78, 0x70, 0x78, 0x6C, 0x66, 0x00 },
    // L
    .{ 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x00 },
    // M
    .{ 0x63, 0x77, 0x7F, 0x7F, 0x6B, 0x63, 0x63, 0x00 },
    // N
    .{ 0x63, 0x67, 0x6F, 0x7B, 0x73, 0x63, 0x63, 0x00 },
    // O
    .{ 0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00 },
    // P
    .{ 0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x60, 0x00 },
    // Q
    .{ 0x3C, 0x66, 0x66, 0x66, 0x6C, 0x36, 0x1A, 0x00 },
    // R
    .{ 0x7C, 0x66, 0x66, 0x7C, 0x78, 0x6C, 0x66, 0x00 },
    // S
    .{ 0x3C, 0x66, 0x60, 0x3C, 0x06, 0x66, 0x3C, 0x00 },
    // T
    .{ 0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00 },
    // U
    .{ 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00 },
    // V
    .{ 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00 },
    // W
    .{ 0x63, 0x63, 0x63, 0x6B, 0x7F, 0x77, 0x63, 0x00 },
    // X
    .{ 0x66, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x66, 0x00 },
    // Y
    .{ 0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x00 },
    // Z
    .{ 0x7E, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x7E, 0x00 },
    // [
    .{ 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00 },
    // \
    .{ 0x00, 0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x00 },
    // ]
    .{ 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00 },
    // ^
    .{ 0x18, 0x3C, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00 },
    // _
    .{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF },
    // `
    .{ 0x30, 0x30, 0x10, 0x20, 0x00, 0x00, 0x00, 0x00 },
    // a
    .{ 0x00, 0x00, 0x3C, 0x02, 0x3E, 0x46, 0x3A, 0x00 },
    // b
    .{ 0x60, 0x60, 0x5C, 0x62, 0x62, 0x62, 0x5C, 0x00 },
    // c
    .{ 0x00, 0x00, 0x3C, 0x42, 0x40, 0x42, 0x3C, 0x00 },
    // d
    .{ 0x02, 0x02, 0x3A, 0x46, 0x46, 0x46, 0x3A, 0x00 },
    // e
    .{ 0x00, 0x00, 0x3C, 0x42, 0x7E, 0x40, 0x3C, 0x00 },
    // f
    .{ 0x1C, 0x20, 0x7E, 0x20, 0x20, 0x20, 0x20, 0x00 },
    // g
    .{ 0x00, 0x00, 0x3A, 0x46, 0x46, 0x3E, 0x06, 0x7C },
    // h
    .{ 0x60, 0x60, 0x5C, 0x62, 0x62, 0x62, 0x62, 0x00 },
    // i
    .{ 0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00 },
    // j
    .{ 0x0C, 0x00, 0x0C, 0x0C, 0x0C, 0x0C, 0x38, 0x20 },
    // k
    .{ 0x60, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0x00 },
    // l
    .{ 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00 },
    // m
    .{ 0x00, 0x00, 0x6C, 0x54, 0x54, 0x54, 0x54, 0x00 },
    // n
    .{ 0x00, 0x00, 0x5C, 0x62, 0x62, 0x62, 0x62, 0x00 },
    // o
    .{ 0x00, 0x00, 0x3C, 0x42, 0x42, 0x42, 0x3C, 0x00 },
    // p
    .{ 0x00, 0x00, 0x5C, 0x62, 0x62, 0x62, 0x5C, 0x60 },
    // q
    .{ 0x00, 0x00, 0x3A, 0x46, 0x46, 0x46, 0x3A, 0x02 },
    // r
    .{ 0x00, 0x00, 0x5C, 0x62, 0x60, 0x60, 0x60, 0x00 },
    // s
    .{ 0x00, 0x00, 0x3C, 0x40, 0x3C, 0x02, 0x3C, 0x00 },
    // t
    .{ 0x20, 0x7E, 0x20, 0x20, 0x20, 0x22, 0x1C, 0x00 },
    // u
    .{ 0x00, 0x00, 0x42, 0x42, 0x42, 0x42, 0x3A, 0x00 },
    // v
    .{ 0x00, 0x00, 0x42, 0x42, 0x42, 0x24, 0x18, 0x00 },
    // w
    .{ 0x00, 0x00, 0x49, 0x49, 0x49, 0x2A, 0x14, 0x00 },
    // x
    .{ 0x00, 0x00, 0x42, 0x24, 0x18, 0x24, 0x42, 0x00 },
    // y
    .{ 0x00, 0x00, 0x42, 0x42, 0x42, 0x3E, 0x06, 0x3C },
    // z
    .{ 0x00, 0x00, 0x7E, 0x04, 0x08, 0x10, 0x7E, 0x00 },
    // {
    .{ 0x08, 0x18, 0x18, 0x10, 0x18, 0x18, 0x08, 0x00 },
    // |
    .{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00 },
    // }
    .{ 0x08, 0x18, 0x18, 0x04, 0x18, 0x18, 0x08, 0x00 },
    // ~
    .{ 0x00, 0x00, 0x76, 0xDC, 0x00, 0x00, 0x00, 0x00 },
    // DEL (127) - Checkerboard
    .{ 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55 },
};

const limine = @import("../../limine_import.zig").C;

/// Draws a single character at (x, y) with the given color.
/// 'c' must be within ASCII 32 - 127.
pub fn drawChar(fb: *limine.struct_limine_framebuffer, x: u64, y: u64, char: u8, color: u32) void {
    if (char < 32 or char > 127) return;

    // Calculate index into font_data
    const index = char - 32;
    const bitmap = font_data[index];

    // Draw 8x8 bitmap
    var row: u64 = 0;
    while (row < 8) : (row += 1) {
        // x check (optional if we trust caller, but safe)
        if (y + row >= fb.height) break;

        const bits = bitmap[row];
        var col: u64 = 0;
        while (col < 8) : (col += 1) {
            if (x + col >= fb.width) break;

            // Check if bit is set (MSB is left)
            // 0x80 = 10000000
            if ((bits & (@as(u8, 0x80) >> @intCast(col))) != 0) {
                framebuffer.putPixel(fb, x + col, y + row, color);
            }
        }
    }
}

/// Draws a string starting at (x, y).
pub fn drawString(fb: *limine.struct_limine_framebuffer, x: u64, y: u64, text: []const u8, color: u32) void {
    var curr_x = x;
    var curr_y = y;

    for (text) |char| {
        if (char == '\n') {
            curr_x = x;
            curr_y += 10; // Newline height (8 + 2 padding)
            continue;
        }

        drawChar(fb, curr_x, curr_y, char, color);
        curr_x += 9; // Advance 8 pixels + 1 padding
    }
}
